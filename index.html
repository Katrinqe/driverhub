<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DriverHub 1.7 Local Audio</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CSS (STYLE) --- */
        :root {
            --bg-color: #000000;
            --accent-blue: #4a90e2;
            --accent-red: #ff3b30;
            --accent-purple: #bf5af2;
            --text-white: #ffffff;
            --text-grey: #8e8e93;
            --glass-bg: rgba(20, 20, 20, 0.85);
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-color); color: var(--text-white); font-family: var(--font-stack);
            overflow: hidden; height: 100vh; width: 100vw;
            overscroll-behavior: none;
        }

        /* INTRO */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000000; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.8s ease;
        }
        .splash-logo { width: 150px; animation: introAnim 2.5s ease-out forwards; }
        @keyframes introAnim {
            0% { opacity: 0; transform: scale(0.8); filter: blur(10px); }
            30% { opacity: 1; transform: scale(1.1); filter: drop-shadow(0 0 30px var(--accent-blue)); }
            100% { opacity: 1; transform: scale(1); filter: drop-shadow(0 0 0px var(--accent-blue)); }
        }

        /* BG */
        .aurora-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; overflow: hidden; }
        .blob { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.25; animation: float 15s infinite ease-in-out; }
        .b1 { top: -10%; left: -10%; width: 80vw; height: 80vw; background: #1c3d6e; }
        .b2 { bottom: -10%; right: -10%; width: 80vw; height: 80vw; background: #2c5f9e; animation-delay: -5s; }
        @keyframes float { 0%, 100% { transform: translate(0,0); } 50% { transform: translate(20px, -20px); } }

        /* UI */
        .status-pill { background: rgba(30,30,30,0.6); backdrop-filter: blur(15px); padding: 8px 18px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); align-items: center; gap: 12px; font-size: 0.9rem; font-weight: 600; margin-bottom: 30px; }
        .loc-icon, #weather-icon { color: var(--accent-blue); }
        .divider { opacity: 0.3; }
        .logo-container { margin-bottom: 25px; }
        .dh-logo { width: 225px; height: auto; filter: drop-shadow(0 0 20px rgba(74,144,226,0.15)); }
        h1 { font-size: 2.2rem; font-weight: 800; letter-spacing: 1px; margin-bottom: 5px; background: linear-gradient(to right, #fff, #a0a0a0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase; }
        .slogan { color: var(--text-grey); font-size: 0.9rem; margin-bottom: 20px; letter-spacing: 1px; text-transform: uppercase; }
        
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; opacity: 0; transition: opacity 0.3s ease; }
        .screen.active { display: flex; opacity: 1; z-index: 10; }
        .screen-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; z-index: 2000; background: #000; animation: slideUp 0.4s ease forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .content-home-layout { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 80px 20px 20px 20px; text-align: center; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 80px 20px 100px 20px; }
        .content-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .spacer-flex { flex: 1; }
        .header-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 50px 20px 10px 20px; background: linear-gradient(to bottom, black, transparent); z-index: 20; }

        button { font-family: var(--font-stack); cursor: pointer; }
        .btn-primary { border: none; padding: 18px 32px; border-radius: 30px; font-size: 1.1rem; font-weight: 600; width: 100%; max-width: 280px; background: linear-gradient(135deg, var(--accent-blue), #2c5f9e); color: white; box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3); margin-bottom: 120px; }
        .btn-danger { border: 1px solid var(--accent-red); background: rgba(255, 59, 48, 0.15); color: var(--accent-red); padding: 16px 32px; border-radius: 30px; font-size: 1.1rem; font-weight: 600; width: 100%; max-width: 280px; backdrop-filter: blur(10px); }
        .icon-btn-floating { position: absolute; top: 40px; left: 20px; width: 45px; height: 45px; background: var(--glass-bg); border-radius: 50%; border: none; color: white; z-index: 3000; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .btn-text { background: transparent; color: #555; font-size: 0.9rem; margin-top: 40px; width: 100%; border: none; }

        /* MAP & STATS */
        #map, #detail-map { height: 100%; width: 100%; z-index: 1; filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        .drive-overlay-top { position: absolute; top: 50px; left: 20px; right: 20px; z-index: 999; display: flex; justify-content: space-between; }
        .drive-overlay-bottom { position: absolute; bottom: 40px; left: 0; right: 0; z-index: 999; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 20px;}
        .stat-box { background: var(--glass-bg); backdrop-filter: blur(15px); padding: 15px 20px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.1); min-width: 100px; }
        .stat-box .value { font-size: 1.8rem; font-weight: 700; font-variant-numeric: tabular-nums; } 
        .stat-box .label { font-size: 0.7rem; color: var(--text-grey); font-weight: 700; } 
        .stat-box .unit { font-size: 0.8rem; color: var(--accent-blue); }
        .drive-overlay-bottom .stat-row { background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 12px; padding: 10px 20px; display: inline-block; border: 1px solid rgba(255,255,255,0.1); font-weight: 600; }

        /* GARAGE */
        .stats-card { background: #1c1c1e; border-radius: 20px; padding: 30px; width: 100%; max-width: 320px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .stat-row-final { display: flex; justify-content: space-between; margin-bottom: 20px; text-align: left; } 
        .stat-row-final .final-value { font-size: 1.8rem; font-weight: 700; color: white; display: block; }
        .drives-list { width: 100%; max-width: 340px; margin: 0 auto; }
        .drive-item { background: #111; border: 1px solid #222; padding: 20px; border-radius: 16px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .drive-item:active { background: #222; }
        .drive-item h4 { font-size: 1rem; color: white; margin-bottom: 5px; } 
        .drive-item span { color: var(--text-grey); font-size: 0.85rem; } 
        .drive-item .right-side { text-align: right; } 
        .drive-item .dist { font-size: 1.2rem; color: var(--accent-blue); font-weight: 700; }
        .detail-stats-overlay { position: absolute; bottom: 40px; left: 20px; right: 20px; background: var(--glass-bg); backdrop-filter: blur(20px); border-radius: 20px; padding: 20px; z-index: 2500; border: 1px solid rgba(255,255,255,0.1); } 
        .mini { margin-bottom: 0; text-align: center; } .mini > div { flex: 1; } .mini .val { font-size: 1.4rem; font-weight: 700; display: block; }

        /* PERF */
        .perf-display { text-align: center; margin-bottom: 40px; }
        .perf-speed { font-size: 5rem; font-weight: 900; color: white; line-height: 1; font-variant-numeric: tabular-nums; text-shadow: 0 0 40px rgba(255, 59, 48, 0.4); }
        .perf-unit { font-size: 1.2rem; color: var(--text-grey); font-weight: 600; }
        .perf-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 320px; margin-bottom: 30px; }
        .perf-box { background: #1c1c1e; padding: 15px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .perf-box.active { border-color: var(--accent-red); box-shadow: 0 0 15px rgba(255,59,48,0.2); }
        .perf-val { display: block; font-size: 1.5rem; font-weight: 700; color: white; margin-top: 5px; }
        .perf-lbl { font-size: 0.75rem; color: var(--text-grey); font-weight: 700; letter-spacing: 1px; }
        .g-force-container { width: 100%; max-width: 320px; margin-bottom: 40px; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px; display: flex; align-items: center; justify-content: space-between; }
        .g-val { font-weight: bold; font-size: 1.2rem; color: var(--accent-blue); }
        .btn-arm { background: var(--accent-red); color: white; border: none; width: 80px; height: 80px; border-radius: 50%; font-weight: 700; font-size: 1rem; box-shadow: 0 0 30px rgba(255,59,48,0.3); text-transform: uppercase; animation: pulse-red 2s infinite; }
        .btn-arm.armed { background: transparent; border: 2px solid var(--accent-red); animation: none; color: var(--accent-red); }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.05); box-shadow: 0 0 50px rgba(255,59,48,0.5); } 100% { transform: scale(1); } }

        /* MUSIC UI */
        .music-player-container { width: 100%; max-width: 320px; display: flex; flex-direction: column; align-items: center; }
        .album-art-wrapper { width: 200px; height: 200px; margin: 20px 0 30px 0; position: relative; display: flex; align-items: center; justify-content: center; }
        .album-art { width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #1c1c1e, #000); box-shadow: 0 0 30px rgba(191, 90, 242, 0.1); position: relative; z-index: 2; display: flex; align-items: center; justify-content: center; border: 2px solid rgba(255,255,255,0.05); }
        .music-icon-big { font-size: 3rem; color: var(--accent-purple); opacity: 0.8; }
        .music-aura { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle, rgba(191,90,242,0.4) 0%, transparent 70%); z-index: 1; opacity: 0; transition: opacity 0.5s; }
        .music-aura.playing { animation: pulse-music 1.5s infinite ease-in-out; opacity: 1; }
        @keyframes pulse-music { 0% { transform: scale(0.9); opacity: 0.3; } 50% { transform: scale(1.2); opacity: 0.6; } 100% { transform: scale(0.9); opacity: 0.3; } }
        .song-info { text-align: center; margin-bottom: 20px; }
        .song-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; color: white; display: block; }
        .song-artist { font-size: 0.9rem; color: var(--accent-purple); text-transform: uppercase; letter-spacing: 1px; }
        
        .controls { display: flex; align-items: center; gap: 30px; margin-bottom: 30px; }
        .btn-ctrl { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; transition: transform 0.1s; }
        .btn-ctrl:active { transform: scale(0.9); }
        .btn-play { width: 70px; height: 70px; border-radius: 50%; background: var(--accent-purple); box-shadow: 0 0 20px rgba(191, 90, 242, 0.4); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
        .volume-container { width: 100%; display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding: 0 10px; }
        .vol-slider { flex: 1; -webkit-appearance: none; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; outline: none; }
        .vol-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: white; cursor: pointer; }
        
        /* FILE LOAD BUTTON STYLING */
        .btn-load-file {
            background: rgba(255,255,255,0.1); color: var(--accent-purple); border: 1px solid var(--accent-purple);
            padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;
        }

        .playlist { width: 100%; text-align: left; }
        .track-row { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .track-row.active { color: var(--accent-purple); }
        .track-row h5 { font-size: 1rem; margin-bottom: 2px; }
        .track-row p { font-size: 0.8rem; opacity: 0.6; }

        /* NAV */
        .bottom-nav { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 380px; height: 70px; background: rgba(30, 30, 30, 0.8); backdrop-filter: blur(20px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; border: 1px solid rgba(255,255,255,0.1); z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { background: none; border: none; color: #666; font-size: 0.8rem; display: flex; flex-direction: column; align-items: center; gap: 5px; width: auto; padding: 0; }
        .nav-item.active { color: var(--accent-blue); }
        .nav-item.active[data-target="perf-screen"] { color: var(--accent-red); }
        .nav-item.active[data-target="music-screen"] { color: var(--accent-purple); }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="logo.png" alt="DriverHub" class="splash-logo" onerror="this.style.display='none'; document.getElementById('splash-text').style.display='block';">
        <h1 id="splash-text" style="display:none; font-size: 2rem;">DH</h1>
    </div>

    <div class="aurora-bg"><div class="blob b1"></div><div class="blob b2"></div></div>

    <div id="app-container">
        <section id="home-screen" class="screen active">
            <div class="content-home-layout">
                <div id="status-widget" class="status-pill" style="display:flex;">
                    <i class="fa-solid fa-location-arrow loc-icon"></i><span id="loc-text">Locating...</span><span class="divider">|</span><i id="weather-icon" class="fa-solid fa-cloud"></i><span id="weather-temp">--°</span>
                </div>
                <div class="logo-container"><img src="logo.png" alt="DriverHub Logo" class="dh-logo" onerror="this.style.display='none';"></div>
                <h1 id="greeting-text">WELCOME</h1>
                <p class="slogan">Built for those who drive.</p>
                <div class="spacer-flex"></div>
                <button id="btn-start" class="btn-primary"><i class="fa-solid fa-road"></i> Start Drive</button>
            </div>
        </section>

        <section id="perf-screen" class="screen">
            <div class="header-bar"><h2>Performance</h2></div>
            <div class="content-scroll">
                <div class="perf-display"><span id="perf-live-speed" class="perf-speed">0</span><span class="perf-unit">KM/H</span></div>
                <div class="perf-grid">
                    <div class="perf-box" id="box-0-50"><span class="perf-lbl">0 - 50</span><span class="perf-val" id="val-0-50">--.- s</span></div>
                    <div class="perf-box" id="box-0-100"><span class="perf-lbl">0 - 100</span><span class="perf-val" id="val-0-100">--.- s</span></div>
                </div>
                <div class="g-force-container"><span class="perf-lbl">MAX G-FORCE</span><span class="g-val" id="max-g-val">0.00 G</span></div>
                <div style="text-align: center; margin-bottom: 30px;">
                    <button id="btn-arm-perf" class="btn-arm">ARM</button>
                    <p style="margin-top:15px; color:#666; font-size:0.8rem;" id="perf-status-text">Tap to arm, then launch.</p>
                </div>
                <h3>History</h3>
                <div id="perf-history-list" class="drives-list"></div>
                <div style="height: 100px;"></div>
            </div>
        </section>

        <section id="music-screen" class="screen">
            <div class="header-bar"><h2>Music</h2></div>
            <div class="content-scroll">
                <div class="music-player-container">
                    
                    <div class="album-art-wrapper">
                        <div class="music-aura" id="music-aura"></div>
                        <div class="album-art"><i class="fa-solid fa-music music-icon-big"></i></div>
                    </div>
                    
                    <div class="song-info">
                        <span class="song-title" id="track-title">Select Music</span>
                        <span class="song-artist" id="track-artist">Local or Stream</span>
                    </div>

                    <input type="file" id="file-input" accept="audio/*" style="display:none">
                    <button class="btn-load-file" onclick="document.getElementById('file-input').click()">
                        <i class="fa-solid fa-folder-open"></i> Eigene Musik laden
                    </button>

                    <div class="controls">
                        <button class="btn-ctrl" id="btn-prev"><i class="fa-solid fa-backward-step"></i></button>
                        <button class="btn-ctrl btn-play" id="btn-play-pause"><i class="fa-solid fa-play"></i></button>
                        <button class="btn-ctrl" id="btn-next"><i class="fa-solid fa-forward-step"></i></button>
                    </div>
                    
                    <div class="volume-container">
                        <i class="fa-solid fa-volume-low" style="color:#888; font-size:0.8rem;"></i>
                        <input type="range" min="0" max="1" step="0.1" value="0.8" class="vol-slider" id="vol-slider">
                        <i class="fa-solid fa-volume-high" style="color:#888; font-size:0.8rem;"></i>
                    </div>
                    
                    <div class="playlist" id="playlist-container"></div>
                </div>
                <div style="height: 100px;"></div>
            </div>
        </section>

        <section id="garage-screen" class="screen">
            <div class="header-bar"><h2>Your Garage</h2></div>
            <div class="content-scroll">
                <div class="stats-card profile-card">
                    <div class="stat-row-final">
                        <div><span class="label">TOTAL KM</span><span class="final-value" id="total-km">0</span></div>
                        <div><span class="label">DRIVES</span><span class="final-value" id="total-drives">0</span></div>
                    </div>
                </div>
                <h3>Recent Drives</h3>
                <div id="drives-list" class="drives-list"></div>
                <button id="btn-reset-data" class="btn-text">Reset Data</button>
                <div style="height: 100px;"></div>
            </div>
        </section>

        <section id="drive-screen" class="screen-overlay">
            <div id="map"></div>
            <div class="drive-overlay-top">
                <div class="stat-box"><span class="label">SPEED</span><span class="value" id="live-speed">0</span><span class="unit">km/h</span></div>
                <div class="stat-box"><span class="label">TIME</span><span class="value" id="live-time">00:00</span></div>
            </div>
            <div class="drive-overlay-bottom">
                <div class="stat-row"><span id="live-dist">0.0 km</span></div>
                <button id="btn-stop" class="btn-danger"><i class="fa-solid fa-stop"></i> End Drive</button>
            </div>
        </section>

        <section id="summary-screen" class="screen-overlay">
            <div class="content-center">
                <h2>Drive Summary</h2>
                <div class="stats-card">
                    <div class="stat-row-final">
                        <div><span class="label">DISTANCE</span><span class="final-value" id="sum-dist">0.0</span><span class="unit">km</span></div>
                        <div><span class="label">MAX SPEED</span><span class="final-value" id="sum-speed">0</span><span class="unit">km/h</span></div>
                    </div>
                    <div class="stat-row-final">
                         <div><span class="label">AVG SPEED</span><span class="final-value" id="sum-avg">0</span><span class="unit">km/h</span></div>
                        <div><span class="label">DURATION</span><span class="final-value" id="sum-time">00:00:00</span></div>
                    </div>
                </div>
                <button id="btn-save-drive" class="btn-primary">Save to Garage</button>
            </div>
        </section>

        <section id="detail-screen" class="screen-overlay">
            <button id="btn-close-detail" class="icon-btn-floating"><i class="fa-solid fa-arrow-left"></i></button>
            <div id="detail-map"></div>
            <div class="detail-stats-overlay">
                <div class="stat-row-final mini">
                    <div><span class="label">KM</span><span id="detail-dist" class="val">0</span></div>
                    <div><span class="label">MAX</span><span id="detail-max" class="val">0</span></div>
                    <div><span class="label">AVG</span><span id="detail-avg" class="val">0</span></div>
                </div>
            </div>
        </section>

        <nav class="bottom-nav" id="main-nav">
            <button class="nav-item active" data-target="home-screen"><i class="fa-solid fa-house"></i><span>Home</span></button>
            <button class="nav-item" data-target="perf-screen"><i class="fa-solid fa-gauge-high"></i><span>Perf</span></button>
            <button class="nav-item" data-target="music-screen"><i class="fa-solid fa-music"></i><span>Music</span></button>
            <button class="nav-item" data-target="garage-screen"><i class="fa-solid fa-layer-group"></i><span>Garage</span></button>
        </nav>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- GLOBAL VARIABLES ---
        let map, marker, watchId, intervalId, detailMap;
        let startTime, path = [], currentDistance = 0, currentMaxSpeed = 0, isDriving = false;
        let perfWatchId = null, perfState = 'idle', perfStartTime = 0;
        let result50 = null, result100 = null, maxG = 0;

        // --- MUSIC SETUP (LOCAL + FALLBACK) ---
        // Backup Track hosted on GitHub Raw (often works on iOS)
        const playlist = [
            { title: "Night Drive (Demo)", artist: "GitHub Raw", src: "https://raw.githubusercontent.com/rafaelreis-hotmart/Audio-Sample-files/master/sample.mp3" }
        ];
        let currentTrackIdx = 0;
        const audioPlayer = new Audio();
        let isPlaying = false;

        // --- DOM ---
        const app = {
            splash: document.getElementById('splash-screen'),
            nav: document.getElementById('main-nav'),
            greet: document.getElementById('greeting-text'),
            locText: document.getElementById('loc-text'),
            tempText: document.getElementById('weather-temp'),
            weatherIcon: document.getElementById('weather-icon'),
            screens: {
                home: document.getElementById('home-screen'),
                garage: document.getElementById('garage-screen'),
                perf: document.getElementById('perf-screen'),
                music: document.getElementById('music-screen'),
                drive: document.getElementById('drive-screen'),
                summary: document.getElementById('summary-screen'),
                detail: document.getElementById('detail-screen')
            },
            display: {
                speed: document.getElementById('live-speed'),
                time: document.getElementById('live-time'),
                dist: document.getElementById('live-dist'),
                sumDist: document.getElementById('sum-dist'),
                sumSpeed: document.getElementById('sum-speed'),
                sumAvg: document.getElementById('sum-avg'),
                sumTime: document.getElementById('sum-time')
            },
            perf: {
                speed: document.getElementById('perf-live-speed'),
                val50: document.getElementById('val-0-50'),
                val100: document.getElementById('val-0-100'),
                box50: document.getElementById('box-0-50'),
                box100: document.getElementById('box-0-100'),
                gVal: document.getElementById('max-g-val'),
                btn: document.getElementById('btn-arm-perf'),
                status: document.getElementById('perf-status-text'),
                list: document.getElementById('perf-history-list')
            },
            music: {
                title: document.getElementById('track-title'),
                artist: document.getElementById('track-artist'),
                playBtn: document.getElementById('btn-play-pause'),
                prevBtn: document.getElementById('btn-prev'),
                nextBtn: document.getElementById('btn-next'),
                volSlider: document.getElementById('vol-slider'),
                list: document.getElementById('playlist-container'),
                aura: document.getElementById('music-aura'),
                fileInput: document.getElementById('file-input')
            }
        };

        // --- INIT ---
        window.addEventListener('load', () => {
            setTimeout(() => { app.splash.style.opacity = '0'; setTimeout(() => app.splash.style.display = 'none', 800); }, 2200);
            renderGarage(); renderPerfHistory(); initMusicPlayer(); updateTimeGreeting();
            if(navigator.geolocation) { navigator.geolocation.getCurrentPosition(initWeatherLoc, err => console.log(err)); }
        });

        function updateTimeGreeting() {
            const h = new Date().getHours(); let txt = "WELCOME";
            if (h >= 5 && h < 12) txt = "GOOD MORNING"; else if (h >= 12 && h < 18) txt = "GOOD AFTERNOON"; else if (h >= 18 && h < 22) txt = "GOOD EVENING"; else txt = "NIGHT CRUISE";
            app.greet.innerText = txt;
        }

        function initWeatherLoc(pos) {
            const lat = pos.coords.latitude; const lng = pos.coords.longitude;
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`).then(r => r.json()).then(d => { app.locText.innerText = d.address.city || d.address.town || "Location Found"; });
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`).then(r => r.json()).then(d => {
                const t = Math.round(d.current_weather.temperature); const c = d.current_weather.weathercode;
                app.tempText.innerText = t + "°";
                if(c <= 1) app.weatherIcon.className = "fa-solid fa-sun"; else if(c <= 3) app.weatherIcon.className = "fa-solid fa-cloud-sun"; else app.weatherIcon.className = "fa-solid fa-cloud";
            });
        }

        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetId = btn.getAttribute('data-target');
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active')); btn.classList.add('active');
                Object.values(app.screens).forEach(s => { if(s && !s.classList.contains('screen-overlay')) s.classList.remove('active'); });
                if(app.screens[targetId.split('-')[0]]) { app.screens[targetId.split('-')[0]].classList.add('active'); }
            });
        });

        // --- MUSIC LOGIC (LOCAL FILE HANDLING) ---
        function initMusicPlayer() {
            // Render Playlist (Default)
            renderPlaylist();

            // Setup Controls
            app.music.playBtn.addEventListener('click', togglePlay);
            app.music.nextBtn.addEventListener('click', nextTrack);
            app.music.prevBtn.addEventListener('click', prevTrack);
            app.music.volSlider.addEventListener('input', (e) => { audioPlayer.volume = e.target.value; });
            
            // LOCAL FILE HANDLER
            app.music.fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Create a secure URL for the file
                const fileUrl = URL.createObjectURL(file);
                
                // Add to playlist top
                playlist.unshift({
                    title: file.name.replace(/\.[^/.]+$/, ""), // remove extension
                    artist: "Local File",
                    src: fileUrl
                });

                renderPlaylist();
                loadTrack(0, true); // Play immediately
            });

            // Error Handling
            audioPlayer.addEventListener('error', (e) => {
                console.error("Audio Error", e);
                alert("Musik konnte nicht laden.\nBitte benutze den 'Eigene Musik laden' Button!");
                isPlaying = false; updatePlayBtn();
            });
        }

        function renderPlaylist() {
            app.music.list.innerHTML = "";
            playlist.forEach((track, index) => {
                const div = document.createElement('div');
                div.className = 'track-row';
                if(index === currentTrackIdx) div.classList.add('active');
                div.innerHTML = `<div><h5>${track.title}</h5><p>${track.artist}</p></div><i class="fa-solid fa-play" style="font-size:0.8rem"></i>`;
                div.addEventListener('click', () => loadTrack(index));
                app.music.list.appendChild(div);
            });
        }

        function loadTrack(index, autoPlay = true) {
            currentTrackIdx = index;
            const track = playlist[index];
            audioPlayer.src = track.src;
            app.music.title.innerText = track.title;
            app.music.artist.innerText = track.artist;
            renderPlaylist(); // Update active class

            if(autoPlay) {
                audioPlayer.play().then(() => {
                    isPlaying = true; updatePlayBtn();
                }).catch(e => {
                    console.log("Play block:", e);
                    isPlaying = false; updatePlayBtn();
                });
            }
        }

        function togglePlay() {
            if(isPlaying) {
                audioPlayer.pause(); isPlaying = false;
            } else {
                audioPlayer.play().catch(e => alert("Please load a local file first!"));
                isPlaying = true;
            }
            updatePlayBtn();
        }

        function updatePlayBtn() {
            if(isPlaying) {
                app.music.playBtn.innerHTML = '<i class="fa-solid fa-pause"></i>';
                app.music.aura.classList.add('playing');
            } else {
                app.music.playBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
                app.music.aura.classList.remove('playing');
            }
        }

        function nextTrack() { let next = currentTrackIdx + 1; if(next >= playlist.length) next = 0; loadTrack(next); }
        function prevTrack() { let prev = currentTrackIdx - 1; if(prev < 0) prev = playlist.length - 1; loadTrack(prev); }


        // --- DRIVE, PERF, GARAGE (UNCHANGED) ---
        document.getElementById('btn-start').addEventListener('click', () => { app.screens.drive.style.display = 'flex'; app.nav.style.display = 'none'; startTracking(); });
        document.getElementById('btn-stop').addEventListener('click', () => { stopTracking(); app.screens.drive.style.display = 'none'; app.screens.summary.style.display = 'flex'; });
        document.getElementById('btn-save-drive').addEventListener('click', () => { saveDriveToStorage(); app.screens.summary.style.display = 'none'; app.nav.style.display = 'flex'; document.querySelectorAll('.nav-item')[3].click(); });

        app.perf.btn.addEventListener('click', () => {
            if(perfState === 'idle' || perfState === 'finished') {
                perfState = 'armed'; app.perf.btn.innerText = "READY"; app.perf.btn.classList.add('armed');
                app.perf.status.innerText = "Launch when ready! Timer starts > 1 km/h";
                app.perf.val50.innerText = "--.- s"; app.perf.val100.innerText = "--.- s";
                app.perf.box50.classList.remove('active'); app.perf.box100.classList.remove('active');
                app.perf.gVal.innerText = "0.00 G"; maxG = 0; result50 = null; result100 = null;
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') { DeviceMotionEvent.requestPermission().then(s => { if (s === 'granted') startPerfSensors(); }).catch(console.error); } else { startPerfSensors(); }
                if (navigator.geolocation) { perfWatchId = navigator.geolocation.watchPosition(updatePerfLogic, handleError, {enableHighAccuracy: true}); }
            } else { resetPerfMode(); }
        });

        function startPerfSensors() { window.addEventListener('devicemotion', handleMotion); }
        function handleMotion(event) {
            if(perfState !== 'running') return;
            const x = event.acceleration.x || 0; const y = event.acceleration.y || 0; const z = event.acceleration.z || 0;
            const totalAccel = Math.sqrt(x*x + y*y + z*z); const currentG = totalAccel / 9.81;
            if(currentG > maxG) { maxG = currentG; app.perf.gVal.innerText = maxG.toFixed(2) + " G"; }
        }

        function updatePerfLogic(position) {
            const speedKmh = (position.coords.speed || 0) * 3.6; app.perf.speed.innerText = speedKmh.toFixed(0);
            if(perfState === 'armed') {
                if(speedKmh > 2.0) { perfState = 'running'; perfStartTime = Date.now(); app.perf.btn.innerText = "GO!"; app.perf.status.innerText = "Recording..."; }
            } else if(perfState === 'running') {
                const duration = (Date.now() - perfStartTime) / 1000;
                if(!result50 && speedKmh >= 50) { result50 = duration.toFixed(2); app.perf.val50.innerText = result50 + " s"; app.perf.box50.classList.add('active'); }
                if(!result100 && speedKmh >= 100) { result100 = duration.toFixed(2); app.perf.val100.innerText = result100 + " s"; app.perf.box100.classList.add('active'); perfState = 'finished'; app.perf.btn.innerText = "RESET"; app.perf.btn.classList.remove('armed'); app.perf.status.innerText = "Run Complete!"; savePerfRun(); }
            }
        }
        function resetPerfMode() { perfState = 'idle'; app.perf.btn.innerText = "ARM"; app.perf.btn.classList.remove('armed'); app.perf.status.innerText = "Tap to arm, then launch."; if(perfWatchId) navigator.geolocation.clearWatch(perfWatchId); window.removeEventListener('devicemotion', handleMotion); app.perf.speed.innerText = "0"; }
        function savePerfRun() { const run = { id: Date.now(), date: new Date().toISOString(), res50: result50, res100: result100, maxG: maxG.toFixed(2) }; let runs = JSON.parse(localStorage.getItem('dh_perf_v1')) || []; runs.unshift(run); localStorage.setItem('dh_perf_v1', JSON.stringify(runs)); renderPerfHistory(); }
        function renderPerfHistory() { let runs = JSON.parse(localStorage.getItem('dh_perf_v1')) || []; const list = app.perf.list; list.innerHTML = ''; runs.forEach(run => { const dateStr = new Date(run.date).toLocaleDateString('de-DE'); const item = document.createElement('div'); item.className = 'drive-item'; item.innerHTML = `<div><h4>${dateStr}</h4><span>Max ${run.maxG} G</span></div><div class="right-side"><span style="color:#ff3b30; font-weight:bold;">0-100: ${run.res100}s</span><br><span style="font-size:0.75rem">0-50: ${run.res50}s</span></div>`; list.appendChild(item); }); }
        
        function startTracking() { isDriving = true; startTime = new Date(); path = []; currentDistance = 0; currentMaxSpeed = 0; if (!map) { map = L.map('map', { zoomControl: false }).setView([51.1657, 10.4515], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}).addTo(map); marker = L.marker([0, 0], {icon: L.divIcon({className: 'c', html: "<div style='background-color:#4a90e2; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px #4a90e2;'></div>", iconSize: [20, 20]})}).addTo(map); } setTimeout(() => { map.invalidateSize(); }, 200); intervalId = setInterval(updateTimer, 1000); if (navigator.geolocation) { watchId = navigator.geolocation.watchPosition(updatePosition, handleError, {enableHighAccuracy: true}); } }
        function updatePosition(position) { const lat = position.coords.latitude; const lng = position.coords.longitude; const speedKmh = Math.max(0, (position.coords.speed || 0) * 3.6).toFixed(0); if (parseFloat(speedKmh) > currentMaxSpeed) currentMaxSpeed = parseFloat(speedKmh); app.display.speed.innerText = speedKmh; const newLatLng = [lat, lng]; marker.setLatLng(newLatLng); map.setView(newLatLng, 18); if (path.length > 0) { currentDistance += map.distance(path[path.length - 1], newLatLng); app.display.dist.innerText = (currentDistance / 1000).toFixed(2) + " km"; } path.push(newLatLng); L.polyline(path, {color: '#4a90e2', weight: 5}).addTo(map); }
        function updateTimer() { const diff = new Date() - startTime; app.display.time.innerText = new Date(diff).toISOString().substr(11, 8); }
        function stopTracking() { isDriving = false; clearInterval(intervalId); navigator.geolocation.clearWatch(watchId); const diff = new Date() - startTime; const distKm = currentDistance / 1000; const durationHours = diff / (1000 * 60 * 60); const avgSpeed = (durationHours > 0) ? (distKm / durationHours).toFixed(1) : 0; app.display.sumDist.innerText = distKm.toFixed(2); app.display.sumSpeed.innerText = currentMaxSpeed; app.display.sumAvg.innerText = avgSpeed; app.display.sumTime.innerText = new Date(diff).toISOString().substr(11, 8); }
        function handleError(err) { console.warn(err); }
        function saveDriveToStorage() { const diff = new Date() - startTime; const distKm = currentDistance / 1000; const durationHours = diff / (1000 * 60 * 60); const avgSpeed = (durationHours > 0) ? (distKm / durationHours).toFixed(1) : 0; const newDrive = { id: Date.now(), date: startTime.toISOString(), distance: parseFloat(distKm.toFixed(2)), maxSpeed: currentMaxSpeed, avgSpeed: avgSpeed, duration: new Date(diff).toISOString().substr(11, 8), pathData: path }; let drives = JSON.parse(localStorage.getItem('dh_drives_v2')) || []; drives.unshift(newDrive); localStorage.setItem('dh_drives_v2', JSON.stringify(drives)); renderGarage(); }
        function renderGarage() { let drives = JSON.parse(localStorage.getItem('dh_drives_v2')) || []; let totalKm = 0; const list = document.getElementById('drives-list'); list.innerHTML = ''; drives.forEach(drive => { totalKm += drive.distance; const dateStr = new Date(drive.date).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }); const item = document.createElement('div'); item.className = 'drive-item'; item.innerHTML = `<div><h4>${dateStr} • ${drive.duration}</h4><span>Avg ${drive.avgSpeed} km/h</span></div><div class="right-side"><span class="dist">${drive.distance.toFixed(1)} km</span><span>Max ${drive.maxSpeed}</span></div>`; item.addEventListener('click', () => openDetailView(drive)); list.appendChild(item); }); document.getElementById('total-km').innerText = totalKm.toFixed(1); document.getElementById('total-drives').innerText = drives.length; }
        function openDetailView(drive) { app.screens.detail.style.display = 'block'; document.getElementById('detail-dist').innerText = drive.distance.toFixed(1); document.getElementById('detail-max').innerText = drive.maxSpeed; document.getElementById('detail-avg').innerText = drive.avgSpeed; setTimeout(() => { if(!detailMap) { detailMap = L.map('detail-map', { zoomControl: false }); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}).addTo(detailMap); } detailMap.eachLayer((layer) => { if (!!layer.toGeoJSON) { detailMap.removeLayer(layer); } }); if(drive.pathData && drive.pathData.length > 0) { const polyline = L.polyline(drive.pathData, {color: '#4a90e2', weight: 5}).addTo(detailMap); detailMap.fitBounds(polyline.getBounds(), {padding: [50, 50]}); } }, 100); }
        document.getElementById('btn-close-detail').addEventListener('click', () => { app.screens.detail.style.display = 'none'; if(detailMap) { detailMap.remove(); detailMap = null; } });
        document.getElementById('btn-reset-data').addEventListener('click', () => { if(confirm("Alles löschen?")) { localStorage.removeItem('dh_drives_v2'); renderGarage(); } });
    </script>
</body>
</html>
