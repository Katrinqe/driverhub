<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DriverHub 3.3.0</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <style>
        /* --- CSS (BASIS 3.1.2 - UNBERÜHRT) --- */
        :root {
            --bg-color: #000000;
            --accent-blue: #4a90e2;
            --accent-red: #ff3b30;
            --accent-purple: #bf5af2;
            --accent-green: #30d158;
            --text-white: #ffffff;
            --text-grey: #8e8e93;
            --glass-bg: rgba(20, 20, 20, 0.85);
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-color); color: var(--text-white); font-family: var(--font-stack);
            overflow: hidden; height: 100vh; width: 100vw;
            overscroll-behavior: none;
        }

        .version-tag { position: fixed; bottom: 2px; right: 5px; opacity: 0.3; font-size: 0.6rem; z-index: 9999; pointer-events: none; font-family: monospace; }

        /* INTRO */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000000; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.8s ease;
        }
        .splash-logo { width: 150px; animation: introAnim 2.5s ease-out forwards; }
        @keyframes introAnim {
            0% { opacity: 0; transform: scale(0.8); filter: blur(10px); }
            30% { opacity: 1; transform: scale(1.1); filter: drop-shadow(0 0 30px var(--accent-blue)); }
            100% { opacity: 1; transform: scale(1); filter: drop-shadow(0 0 0px var(--accent-blue)); }
        }

        /* AUTH SCREEN */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000000; z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; transition: transform 0.3s ease;
        }
        #auth-screen.hidden { transform: translateY(100%); pointer-events: none; }
        .auth-box { width: 100%; max-width: 320px; text-align: center; }
        .auth-input { width: 100%; padding: 15px; margin-bottom: 15px; background: #1c1c1e; border: 1px solid #333; border-radius: 12px; color: white; font-size: 1rem; outline: none; }
        .btn-auth { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 1rem; font-weight: 700; margin-bottom: 15px; cursor: pointer; }
        .btn-login { background: var(--accent-blue); color: white; }
        .btn-google { background: white; color: black; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .auth-switch { color: var(--accent-blue); font-size: 0.9rem; margin-top: 20px; cursor: pointer; }

        /* BG */
        .aurora-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; overflow: hidden; }
        .blob { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.25; animation: float 15s infinite ease-in-out; }
        .b1 { top: -10%; left: -10%; width: 80vw; height: 80vw; background: #1c3d6e; }
        .b2 { bottom: -10%; right: -10%; width: 80vw; height: 80vw; background: #2c5f9e; animation-delay: -5s; }
        @keyframes float { 0%, 100% { transform: translate(0,0); } 50% { transform: translate(20px, -20px); } }

        /* UI */
        .status-pill { background: rgba(30,30,30,0.6); backdrop-filter: blur(15px); padding: 8px 18px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); align-items: center; gap: 12px; font-size: 0.9rem; font-weight: 600; margin-bottom: 30px; cursor: pointer; }
        .loc-icon, #weather-icon { color: var(--accent-blue); }
        .divider { opacity: 0.3; }
        .logo-container { margin-bottom: 25px; position: relative; display: inline-block; transition: transform 0.2s; }
        .logo-container:active { transform: scale(0.95); }
        .dh-logo { width: 225px; height: auto; filter: drop-shadow(0 0 20px rgba(74,144,226,0.15)); transition: filter 0.3s ease; }
        .logo-container.listening .dh-logo { filter: drop-shadow(0 0 30px rgba(255, 59, 48, 0.8)); animation: pulse-listen 1.5s infinite; }
        @keyframes pulse-listen { 0% { filter: drop-shadow(0 0 20px rgba(255, 59, 48, 0.6)); transform: scale(1); } 50% { filter: drop-shadow(0 0 50px rgba(255, 59, 48, 1)); transform: scale(1.02); } 100% { filter: drop-shadow(0 0 20px rgba(255, 59, 48, 0.6)); transform: scale(1); } }

        h1 { font-size: 2.2rem; font-weight: 800; letter-spacing: 1px; margin-bottom: 5px; background: linear-gradient(to right, #fff, #a0a0a0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase; }
        .slogan { color: var(--text-grey); font-size: 0.9rem; margin-bottom: 20px; letter-spacing: 1px; text-transform: uppercase; }
        
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; opacity: 0; transition: opacity 0.3s ease; }
        .screen.active { display: flex; opacity: 1; z-index: 10; }
        .screen-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; z-index: 2000; background: #000; animation: slideUp 0.4s ease forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .content-home-layout { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 80px 20px 20px 20px; text-align: center; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 80px 20px 100px 20px; }
        .content-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .spacer-flex { flex: 1; }
        .header-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 50px 20px 10px 20px; background: linear-gradient(to bottom, black, transparent); z-index: 20; display:flex; justify-content:space-between; align-items:center; }

        button { font-family: var(--font-stack); cursor: pointer; }
        .btn-primary { border: none; padding: 18px 32px; border-radius: 30px; font-size: 1.1rem; font-weight: 600; width: 100%; max-width: 280px; background: linear-gradient(135deg, var(--accent-blue), #2c5f9e); color: white; box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3); margin-bottom: 120px; }
        .btn-danger { border: 1px solid var(--accent-red); background: rgba(255, 59, 48, 0.15); color: var(--accent-red); padding: 16px 32px; border-radius: 30px; font-size: 1.1rem; font-weight: 600; width: 100%; max-width: 280px; backdrop-filter: blur(10px); }
        .icon-btn-floating { position: absolute; top: 40px; left: 20px; width: 45px; height: 45px; background: var(--glass-bg); border-radius: 50%; border: none; color: white; z-index: 3000; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .btn-text { background: transparent; color: #555; font-size: 0.9rem; margin-top: 40px; width: 100%; border: none; }

        /* --- NEW SOCIAL STYLES (FIXED) --- */
        .feed-container { width: 100%; max-width: 360px; margin: 0 auto; }
        .post-card { background: #1c1c1e; border-radius: 16px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; }
        .post-avatar { width: 35px; height: 35px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; background-size: cover; background-position: center; border: 1px solid #444; }
        .post-user { font-weight: 700; color: white; font-size: 0.95rem; }
        .post-date { font-size: 0.75rem; color: #666; margin-left: auto; }
        .post-content { font-size: 0.95rem; color: #ddd; line-height: 1.4; margin-bottom: 10px; }
        .post-actions { display: flex; gap: 15px; }
        .action-btn { color: #888; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .action-btn:hover { color: var(--accent-green); }
        
        .create-post-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; margin-bottom: 25px; display: flex; gap: 10px; align-items: center; }
        .create-input { flex: 1; background: transparent; border: none; color: white; font-size: 1rem; outline: none; }
        .btn-send-post { width: 40px; height: 40px; border-radius: 50%; background: var(--accent-green); border: none; color: white; font-size: 1rem; cursor: pointer; }
        .user-search-bar { width: 100%; padding: 12px; border-radius: 12px; background: #111; border: 1px solid #333; color: white; margin-bottom: 20px; outline: none; }
        
        #profile-view, #chat-view { display: none; width: 100%; max-width: 360px; margin: 0 auto; text-align: center; }
        .profile-header-img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent-blue); margin: 0 auto 15px auto; background: #222; background-size: cover; background-position: center; position: relative; }
        .profile-header-img .edit-badge { position: absolute; bottom: 0; right: 0; background: var(--accent-blue); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border: 2px solid black; cursor: pointer; }
        .profile-name { font-size: 1.5rem; font-weight: 800; color: white; margin-bottom: 5px; }
        .profile-bio { color: #aaa; font-size: 0.9rem; margin-bottom: 20px; font-style: italic; padding: 0 20px; }
        .profile-stats { display: flex; justify-content: space-around; margin-bottom: 25px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; }
        .p-stat { display: flex; flex-direction: column; } .p-stat span:first-child { font-weight: 800; font-size: 1.2rem; } .p-stat span:last-child { font-size: 0.7rem; color: #888; text-transform: uppercase; }
        
        .profile-actions-row { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .btn-follow { background: var(--accent-blue); border: none; color: white; padding: 8px 25px; border-radius: 20px; font-weight: 700; cursor: pointer; }
        .btn-follow.following { background: transparent; border: 1px solid #444; color: #888; }
        .btn-chat { background: #333; border: none; color: white; padding: 8px 25px; border-radius: 20px; font-weight: 700; cursor: pointer; }

        #search-results { background: #111; border-radius: 0 0 12px 12px; max-height: 200px; overflow-y: auto; display: none; position: absolute; width: calc(100% - 40px); z-index: 50; top: 135px; border: 1px solid #333; }
        .search-item { padding: 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #222; cursor: pointer; }
        .search-item:hover { background: #222; }
        .s-avatar { width: 30px; height: 30px; border-radius: 50%; background: #333; background-size: cover; background-position: center; }

        /* CHAT */
        .chat-container { height: 400px; display: flex; flex-direction: column; background: #111; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-bubble { padding: 10px 15px; border-radius: 15px; max-width: 80%; word-wrap: break-word; font-size: 0.9rem; }
        .chat-bubble.me { align-self: flex-end; background: var(--accent-blue); color: white; border-bottom-right-radius: 2px; }
        .chat-bubble.them { align-self: flex-start; background: #333; color: white; border-bottom-left-radius: 2px; }
        .chat-input-area { padding: 10px; background: #222; display: flex; gap: 10px; }
        .chat-input { flex: 1; background: #111; border: none; color: white; padding: 10px; border-radius: 20px; outline: none; }
        .no-friends-box { text-align: center; padding: 40px 20px; color: #666; }
        .no-friends-box i { font-size: 3rem; margin-bottom: 15px; opacity: 0.5; }

        /* ALL MODULES (BASIS 3.1.2) */
        #map, #detail-map { height: 100%; width: 100%; z-index: 1; filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        .drive-overlay-top { position: absolute; top: 50px; left: 20px; right: 20px; z-index: 999; display: flex; justify-content: space-between; }
        .drive-overlay-bottom { position: absolute; bottom: 40px; left: 0; right: 0; z-index: 999; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 20px;}
        .stat-box { background: var(--glass-bg); backdrop-filter: blur(15px); padding: 15px 20px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.1); min-width: 100px; } .stat-box .value { font-size: 1.8rem; font-weight: 700; } .stat-box .label { font-size: 0.7rem; color: var(--text-grey); font-weight: 700; } .stat-box .unit { font-size: 0.8rem; color: var(--accent-blue); }
        .drive-overlay-bottom .stat-row { background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 12px; padding: 10px 20px; display: inline-block; border: 1px solid rgba(255,255,255,0.1); font-weight: 600; }
        .stats-card { background: #1c1c1e; border-radius: 20px; padding: 30px; width: 100%; max-width: 320px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .stat-row-final { display: flex; justify-content: space-between; margin-bottom: 20px; text-align: left; } .stat-row-final .final-value { font-size: 1.8rem; font-weight: 700; color: white; display: block; }
        .drives-list { width: 100%; max-width: 340px; margin: 0 auto; } .drive-item { background: #111; border: 1px solid #222; padding: 20px; border-radius: 16px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; } .drive-item:active { background: #222; } .drive-item h4 { font-size: 1rem; color: white; margin-bottom: 5px; } .drive-item span { color: var(--text-grey); font-size: 0.85rem; } .drive-item .right-side { text-align: right; } .drive-item .dist { font-size: 1.2rem; color: var(--accent-blue); font-weight: 700; }
        .detail-stats-overlay { position: absolute; bottom: 40px; left: 20px; right: 20px; background: var(--glass-bg); backdrop-filter: blur(20px); border-radius: 20px; padding: 20px; z-index: 2500; border: 1px solid rgba(255,255,255,0.1); } .mini { margin-bottom: 0; text-align: center; } .mini > div { flex: 1; } .mini .val { font-size: 1.4rem; font-weight: 700; display: block; }
        .perf-display { text-align: center; margin-bottom: 40px; } .perf-speed { font-size: 5rem; font-weight: 900; color: white; line-height: 1; font-variant-numeric: tabular-nums; text-shadow: 0 0 40px rgba(255, 59, 48, 0.4); } .perf-unit { font-size: 1.2rem; color: var(--text-grey); font-weight: 600; }
        .perf-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 320px; margin-bottom: 30px; } .perf-box { background: #1c1c1e; padding: 15px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.05); } .perf-box.active { border-color: var(--accent-red); box-shadow: 0 0 15px rgba(255,59,48,0.2); } .perf-val { display: block; font-size: 1.5rem; font-weight: 700; color: white; margin-top: 5px; } .perf-lbl { font-size: 0.75rem; color: var(--text-grey); font-weight: 700; letter-spacing: 1px; }
        .g-force-container { width: 100%; max-width: 320px; margin-bottom: 40px; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px; display: flex; align-items: center; justify-content: space-between; } .g-val { font-weight: bold; font-size: 1.2rem; color: var(--accent-blue); }
        .btn-arm { background: var(--accent-red); color: white; border: none; width: 80px; height: 80px; border-radius: 50%; font-weight: 700; font-size: 1rem; box-shadow: 0 0 30px rgba(255,59,48,0.3); text-transform: uppercase; animation: pulse-red 2s infinite; } .btn-arm.armed { background: transparent; border: 2px solid var(--accent-red); animation: none; color: var(--accent-red); }
        .music-player-container { width: 100%; max-width: 320px; display: flex; flex-direction: column; align-items: center; } .album-art-wrapper { width: 200px; height: 200px; margin: 20px 0 30px 0; position: relative; display: flex; align-items: center; justify-content: center; } .album-art { width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #1c1c1e, #000); box-shadow: 0 0 30px rgba(191, 90, 242, 0.1); position: relative; z-index: 2; display: flex; align-items: center; justify-content: center; border: 2px solid rgba(255,255,255,0.05); } .music-icon-big { font-size: 3rem; color: var(--accent-purple); opacity: 0.8; } .music-aura { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle, rgba(191,90,242,0.4) 0%, transparent 70%); z-index: 1; opacity: 0; transition: opacity 0.5s; } .music-aura.playing { animation: pulse-music 1.5s infinite ease-in-out; opacity: 1; }
        .song-info { text-align: center; margin-bottom: 20px; } .song-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; color: white; display: block; } .song-artist { font-size: 0.9rem; color: var(--accent-purple); text-transform: uppercase; letter-spacing: 1px; }
        .controls { display: flex; align-items: center; gap: 30px; margin-bottom: 30px; } .btn-ctrl { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; transition: transform 0.1s; } .btn-ctrl:active { transform: scale(0.9); } .btn-play { width: 70px; height: 70px; border-radius: 50%; background: var(--accent-purple); box-shadow: 0 0 20px rgba(191, 90, 242, 0.4); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
        .volume-container { width: 100%; display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding: 0 10px; } .vol-slider { flex: 1; -webkit-appearance: none; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; outline: none; } .vol-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: white; cursor: pointer; }
        .btn-load-file { background: rgba(255,255,255,0.1); color: var(--accent-purple); border: 1px solid var(--accent-purple); padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .playlist { width: 100%; text-align: left; } .track-row { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; display: flex; align-items: center; justify-content: space-between; } .track-row.active { color: var(--accent-purple); } .track-row h5 { font-size: 1rem; margin-bottom: 2px; } .track-row p { font-size: 0.8rem; opacity: 0.6; }

        /* NAV */
        .bottom-nav { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 98%; max-width: 400px; height: 70px; background: rgba(30, 30, 30, 0.8); backdrop-filter: blur(20px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; border: 1px solid rgba(255,255,255,0.1); z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { background: none; border: none; color: #666; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; gap: 5px; width: auto; padding: 0; min-width: 50px; }
        .nav-item i { font-size: 1.1rem; }
        .nav-item.active { color: var(--accent-blue); }
        .nav-item.active[data-target="perf-screen"] { color: var(--accent-red); }
        .nav-item.active[data-target="music-screen"] { color: var(--accent-purple); }
        .nav-item.active[data-target="community-screen"] { color: var(--accent-green); }
    </style>
</head>
<body>

    <div class="version-tag">v3.3.0</div>

    <div id="auth-screen">
        <div class="auth-box">
            <div style="margin-bottom:30px;"><img src="logo.png" alt="DH" style="width:100px; filter:drop-shadow(0 0 20px #007aff);"></div>
            <h2 style="margin-bottom:10px;">DriverHub Login</h2>
            <p style="color:#888; margin-bottom:30px;">Join the Car Community.</p>
            <div id="email-login-form">
                <input type="email" id="auth-email" class="auth-input" placeholder="Email">
                <input type="password" id="auth-pass" class="auth-input" placeholder="Password">
                <button class="btn-auth btn-login" id="btn-login-email">Log In</button>
                <button class="btn-auth btn-login" id="btn-signup-email" style="background:#333; display:none;">Sign Up</button>
            </div>
            <p style="margin:15px 0; color:#555;">- OR -</p>
            <button class="btn-auth btn-google" id="btn-login-google"><i class="fa-brands fa-google"></i> Sign in with Google</button>
            <p class="auth-switch" id="auth-switch-btn">No account? Sign Up</p>
        </div>
    </div>

    <div id="splash-screen"><img src="logo.png" alt="DriverHub" class="splash-logo" onerror="this.style.display='none'; document.getElementById('splash-text').style.display='block';"><h1 id="splash-text" style="display:none; font-size: 2rem;">DH</h1></div>
    <div class="aurora-bg"><div class="blob b1"></div><div class="blob b2"></div></div>

    <div id="app-container">
        <section id="home-screen" class="screen active">
            <div class="content-home-layout">
                <div id="status-widget" class="status-pill" style="display:flex;" onclick="manualRefreshWeather()">
                    <i class="fa-solid fa-location-arrow loc-icon"></i><span id="loc-text">Locating...</span><span class="divider">|</span><i id="weather-icon" class="fa-solid fa-cloud"></i><span id="weather-temp">--°</span>
                </div>
                <div class="logo-container" id="copilot-trigger"><img src="logo.png" alt="DriverHub Logo" class="dh-logo" onerror="this.style.display='none';"></div>
                <h1 id="greeting-text">WELCOME</h1>
                <p class="slogan" id="slogan-text">Tap Logo for Co-Pilot</p>
                <div class="spacer-flex"></div>
                <button id="btn-start" class="btn-primary"><i class="fa-solid fa-road"></i> Start Drive</button>
            </div>
        </section>

        <section id="community-screen" class="screen">
            <div class="header-bar">
                <h2 id="comm-title">Community</h2>
                <i class="fa-solid fa-user-circle" id="user-profile-icon" style="font-size:1.5rem; cursor:pointer;"></i>
            </div>
            
            <div class="content-scroll">
                
                <div id="feed-view">
                    <div style="position:relative;">
                        <input type="text" id="user-search" class="user-search-bar" placeholder="Find Users & Friends...">
                        <div id="search-results"></div>
                    </div>

                    <div id="friends-only-feed">
                         <div class="no-friends-box" id="no-friends-msg">
                            <i class="fa-solid fa-user-group"></i>
                            <p>Du folgst noch niemandem.</p>
                            <p style="font-size:0.8rem; margin-top:10px;">Suche oben nach Freunden, um ihre Posts hier zu sehen!</p>
                        </div>
                    </div>
                </div>

                <div id="profile-view">
                    <div class="profile-header-img" id="p-header-img">
                         <div class="edit-badge" id="btn-edit-img"><i class="fa-solid fa-camera"></i></div>
                    </div>
                    <input type="file" id="profile-img-input" style="display:none;" accept="image/*">
                    
                    <h2 class="profile-name" id="p-name">Loading...</h2>
                    <p class="profile-bio" id="p-bio">...</p>
                    <i class="fa-solid fa-pen" id="btn-edit-bio" style="font-size:0.8rem; color:#666; cursor:pointer; margin-bottom:15px; display:inline-block; padding:5px;"> Edit Bio</i>

                    <div class="profile-stats">
                        <div class="p-stat"><span id="p-followers">0</span><span>Followers</span></div>
                        <div class="p-stat"><span id="p-following">0</span><span>Following</span></div>
                    </div>

                    <div class="profile-actions-row">
                        <button id="btn-follow-action" class="btn-follow" style="display:none;">Follow</button>
                        <button id="btn-msg-action" class="btn-chat" style="display:none;"><i class="fa-regular fa-envelope"></i> Message</button>
                    </div>

                    <hr style="border:0; border-top:1px solid #222; margin:20px 0;">
                    
                    <div id="profile-post-section" style="display:none;">
                         <div class="create-post-box">
                            <input type="text" id="post-input" class="create-input" placeholder="Poste etwas auf dein Profil...">
                            <button class="btn-send-post" id="btn-post"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                        <h3>Deine Posts</h3>
                    </div>
                    
                    <div id="profile-posts-list"></div>

                    <button id="btn-back-feed" class="btn-text">Back to Feed</button>
                </div>

                <div id="chat-view">
                    <h3 id="chat-partner-name" style="margin-bottom:15px;">Chat</h3>
                    <div class="chat-container">
                        <div id="chat-messages" class="chat-messages"></div>
                        <div class="chat-input-area">
                            <input type="text" id="chat-input" class="chat-input" placeholder="Type a message...">
                            <button id="chat-send" class="btn-send-post"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>
                    <button id="btn-close-chat" class="btn-text">Close Chat</button>
                </div>

                <div style="height: 100px;"></div>
            </div>
        </section>

        <section id="perf-screen" class="screen">
            <div class="header-bar"><h2>Performance</h2></div>
            <div class="content-scroll">
                <div class="perf-display"><span id="perf-live-speed" class="perf-speed">0</span><span class="perf-unit">KM/H</span></div>
                <div class="perf-grid">
                    <div class="perf-box" id="box-0-50"><span class="perf-lbl">0 - 50</span><span class="perf-val" id="val-0-50">--.- s</span></div>
                    <div class="perf-box" id="box-0-100"><span class="perf-lbl">0 - 100</span><span class="perf-val" id="val-0-100">--.- s</span></div>
                </div>
                <div class="g-force-container"><span class="perf-lbl">MAX G-FORCE</span><span class="g-val" id="max-g-val">0.00 G</span></div>
                <div style="text-align: center; margin-bottom: 30px;">
                    <button id="btn-arm-perf" class="btn-arm">ARM</button>
                    <p style="margin-top:15px; color:#666; font-size:0.8rem;" id="perf-status-text">Tap to arm, then launch.</p>
                </div>
                <h3>History</h3>
                <div id="perf-history-list" class="drives-list"></div>
                <div style="height: 100px;"></div>
            </div>
        </section>

        <section id="music-screen" class="screen">
            <div class="header-bar"><h2>Music</h2></div>
            <div class="content-scroll">
                <div class="music-player-container">
                    <div class="album-art-wrapper"><div class="music-aura" id="music-aura"></div><div class="album-art"><i class="fa-solid fa-music music-icon-big"></i></div></div>
                    <div class="song-info"><span class="song-title" id="track-title">Select Music</span><span class="song-artist" id="track-artist">Local File</span></div>
                    <input type="file" id="file-input" accept="audio/*,.mp3,.wav,.m4a,.aac" style="display:none">
                    <button class="btn-load-file" onclick="document.getElementById('file-input').click()"><i class="fa-solid fa-folder-open"></i> Eigene Musik laden</button>
                    <div class="controls">
                        <button class="btn-ctrl" id="btn-prev"><i class="fa-solid fa-backward-step"></i></button>
                        <button class="btn-ctrl btn-play" id="btn-play-pause"><i class="fa-solid fa-play"></i></button>
                        <button class="btn-ctrl" id="btn-next"><i class="fa-solid fa-forward-step"></i></button>
                    </div>
                    <div class="volume-container"><i class="fa-solid fa-volume-low" style="color:#888; font-size:0.8rem;"></i><input type="range" min="0" max="1" step="0.1" value="0.8" class="vol-slider" id="vol-slider"><i class="fa-solid fa-volume-high" style="color:#888; font-size:0.8rem;"></i></div>
                    <div class="playlist" id="playlist-container"></div>
                </div>
                <div style="height: 100px;"></div>
            </div>
        </section>

        <section id="garage-screen" class="screen">
            <div class="header-bar"><h2>Your Garage</h2></div>
            <div class="content-scroll">
                <div class="stats-card profile-card">
                    <div class="stat-row-final"><div><span class="label">TOTAL KM</span><span class="final-value" id="total-km">0</span></div><div><span class="label">DRIVES</span><span class="final-value" id="total-drives">0</span></div></div>
                </div>
                <h3>Recent Drives</h3>
                <div id="drives-list" class="drives-list"></div>
                <button id="btn-reset-data" class="btn-text">Reset Data</button>
                <div style="height: 100px;"></div>
            </div>
        </section>

        <section id="drive-screen" class="screen-overlay">
            <div id="map"></div>
            <div class="drive-overlay-top"><div class="stat-box"><span class="label">SPEED</span><span class="value" id="live-speed">0</span><span class="unit">km/h</span></div><div class="stat-box"><span class="label">TIME</span><span class="value" id="live-time">00:00</span></div></div>
            <div class="drive-overlay-bottom"><div class="stat-row"><span id="live-dist">0.0 km</span></div><button id="btn-stop" class="btn-danger"><i class="fa-solid fa-stop"></i> End Drive</button></div>
        </section>

        <section id="summary-screen" class="screen-overlay">
            <div class="content-center">
                <h2>Drive Summary</h2>
                <div class="stats-card">
                    <div class="stat-row-final"><div><span class="label">DISTANCE</span><span class="final-value" id="sum-dist">0.0</span><span class="unit">km</span></div><div><span class="label">MAX SPEED</span><span class="final-value" id="sum-speed">0</span><span class="unit">km/h</span></div></div>
                    <div class="stat-row-final"><div><span class="label">AVG SPEED</span><span class="final-value" id="sum-avg">0</span><span class="unit">km/h</span></div><div><span class="label">DURATION</span><span class="final-value" id="sum-time">00:00:00</span></div></div>
                </div>
                <button id="btn-save-drive" class="btn-primary">Save to Garage</button>
            </div>
        </section>

        <section id="detail-screen" class="screen-overlay">
            <button id="btn-close-detail" class="icon-btn-floating"><i class="fa-solid fa-arrow-left"></i></button>
            <div id="detail-map"></div>
            <div class="detail-stats-overlay">
                <div class="stat-row-final mini"><div><span class="label">KM</span><span id="detail-dist" class="val">0</span></div><div><span class="label">MAX</span><span id="detail-max" class="val">0</span></div><div><span class="label">AVG</span><span id="detail-avg" class="val">0</span></div></div>
            </div>
        </section>

        <nav class="bottom-nav" id="main-nav">
            <button class="nav-item active" data-target="home-screen"><i class="fa-solid fa-house"></i><span>Home</span></button>
            <button class="nav-item" data-target="perf-screen"><i class="fa-solid fa-gauge-high"></i><span>Perf</span></button>
            <button class="nav-item" data-target="community-screen"><i class="fa-solid fa-users"></i><span>Social</span></button>
            <button class="nav-item" data-target="music-screen"><i class="fa-solid fa-music"></i><span>Music</span></button>
            <button class="nav-item" data-target="garage-screen"><i class="fa-solid fa-layer-group"></i><span>Garage</span></button>
        </nav>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- FIREBASE CONFIG (DEINE) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD5pKzbwiM4NRGGyFV1uWIS6dZG30u8ueg",
            authDomain: "driverhub-5a567.firebaseapp.com",
            projectId: "driverhub-5a567",
            storageBucket: "driverhub-5a567.firebasestorage.app",
            messagingSenderId: "977759380742",
            appId: "1:977759380742:web:cc6c0bf4123492aaf62a87",
            measurementId: "G-QWC0ZFBVFT"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db_fire = firebase.firestore();
        const storage = firebase.storage();

        // --- VARIABLES ---
        let map, marker, watchId, intervalId, detailMap;
        let startTime, path = [], currentDistance = 0, currentMaxSpeed = 0, isDriving = false;
        let perfWatchId = null, perfState = 'idle', perfStartTime = 0;
        let result50 = null, result100 = null, maxG = 0;
        const playlist = []; let currentTrackIdx = 0; const audioPlayer = new Audio(); let isPlaying = false;
        let recognition = null; let isListening = false; let synth = window.speechSynthesis;
        let currentUser = null; let viewingUserUid = null; let activeChatId = null;

        // --- DOM ---
        const app = {
            splash: document.getElementById('splash-screen'),
            nav: document.getElementById('main-nav'),
            greet: document.getElementById('greeting-text'),
            locText: document.getElementById('loc-text'),
            tempText: document.getElementById('weather-temp'),
            weatherIcon: document.getElementById('weather-icon'),
            copilotTrigger: document.getElementById('copilot-trigger'),
            authScreen: document.getElementById('auth-screen'),
            
            screens: {
                home: document.getElementById('home-screen'),
                garage: document.getElementById('garage-screen'),
                perf: document.getElementById('perf-screen'),
                music: document.getElementById('music-screen'),
                community: document.getElementById('community-screen'),
                drive: document.getElementById('drive-screen'),
                summary: document.getElementById('summary-screen'),
                detail: document.getElementById('detail-screen')
            },
            display: {
                speed: document.getElementById('live-speed'),
                time: document.getElementById('live-time'),
                dist: document.getElementById('live-dist')
            },
            perf: {
                speed: document.getElementById('perf-live-speed'),
                gVal: document.getElementById('max-g-val'),
                btn: document.getElementById('btn-arm-perf'),
                status: document.getElementById('perf-status-text'),
                list: document.getElementById('perf-history-list'),
                val50: document.getElementById('val-0-50'),
                val100: document.getElementById('val-0-100'),
                box50: document.getElementById('box-0-50'),
                box100: document.getElementById('box-0-100'),
            },
            music: {
                title: document.getElementById('track-title'),
                artist: document.getElementById('track-artist'),
                playBtn: document.getElementById('btn-play-pause'),
                prevBtn: document.getElementById('btn-prev'),
                nextBtn: document.getElementById('btn-next'),
                volSlider: document.getElementById('vol-slider'),
                list: document.getElementById('playlist-container'),
                aura: document.getElementById('music-aura'),
                fileInput: document.getElementById('file-input')
            },
            comm: {
                feed: document.getElementById('friends-only-feed'),
                postInput: document.getElementById('post-input'),
                postBtn: document.getElementById('btn-post'),
                feedView: document.getElementById('feed-view'),
                profileView: document.getElementById('profile-view'),
                chatView: document.getElementById('chat-view'),
                profileIcon: document.getElementById('user-profile-icon'),
                search: document.getElementById('user-search'),
                results: document.getElementById('search-results')
            }
        };

        // --- INIT ---
        window.addEventListener('load', () => {
            setTimeout(() => { app.splash.style.opacity = '0'; setTimeout(() => { app.splash.style.display = 'none'; manualRefreshWeather(); }, 800); }, 2200);
            
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    app.authScreen.classList.add('hidden');
                    initUserProfile();
                    loadFriendsFeed();
                } else {
                    app.authScreen.classList.remove('hidden');
                }
            });

            renderGarage(); renderPerfHistory(); initMusicPlayer(); updateTimeGreeting(); initCoPilot(); loadMusicFromDB();
            setInterval(manualRefreshWeather, 60000); 
        });

        // --- AUTH & PROFILE INIT ---
        function initUserProfile() {
            // Check if profile doc exists, if not create it (Fixes "Loading..." issue)
            db_fire.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                if (!doc.exists) {
                    const baseData = {
                        email: currentUser.email,
                        username: currentUser.email.split('@')[0],
                        bio: "DriverHub User",
                        photoURL: "",
                        followers: 0,
                        following: 0,
                        searchKey: currentUser.email.split('@')[0].toLowerCase(),
                        joined: new Date()
                    };
                    db_fire.collection('users').doc(currentUser.uid).set(baseData);
                } else {
                    const data = doc.data();
                    if(data.photoURL) {
                        app.comm.profileIcon.style.backgroundImage = `url('${data.photoURL}')`;
                        app.comm.profileIcon.style.backgroundSize = 'cover';
                        app.comm.profileIcon.classList.remove('fa-user-circle');
                    }
                }
            });
        }

        // --- SOCIAL: FEED & SEARCH ---
        app.comm.postBtn.addEventListener('click', () => {
            const txt = app.comm.postInput.value; if(!txt) return;
            createPost(txt);
            app.comm.postInput.value = "";
        });

        function createPost(text) {
             db_fire.collection('users').doc(currentUser.uid).get().then(doc => {
                const uData = doc.data() || {};
                db_fire.collection('posts').add({ 
                    text: text, 
                    uid: currentUser.uid, 
                    author: uData.username || "User",
                    authorPic: uData.photoURL || "",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                });
            });
        }

        function loadFriendsFeed() {
            // First get who we follow
            db_fire.collection('follows').where('followerId', '==', currentUser.uid).onSnapshot(snap => {
                if(snap.empty) {
                    document.getElementById('no-friends-msg').style.display = 'block';
                    app.comm.feed.innerHTML = "";
                    app.comm.feed.appendChild(document.getElementById('no-friends-msg'));
                    return;
                }
                
                document.getElementById('no-friends-msg').style.display = 'none';
                const followingIds = [];
                snap.forEach(doc => followingIds.push(doc.data().followingId));
                followingIds.push(currentUser.uid); // See own posts too

                // Fetch posts (Simple client side filter for now as 'in' query is limited)
                db_fire.collection('posts').orderBy('timestamp', 'desc').limit(50).onSnapshot(postSnap => {
                    const container = app.comm.feed;
                    // Keep the "no friends" msg but hidden if we have posts
                    const msg = document.getElementById('no-friends-msg');
                    container.innerHTML = "";
                    container.appendChild(msg);

                    postSnap.forEach(doc => {
                        const post = doc.data();
                        if(followingIds.includes(post.uid)) {
                             renderPost(post, container);
                        }
                    });
                });
            });
        }

        function renderPost(post, container) {
            const date = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "Now";
            let avaStyle = `background: var(--accent-blue);`;
            let avaContent = post.author.charAt(0).toUpperCase();
            if(post.authorPic) { avaStyle = `background-image: url('${post.authorPic}');`; avaContent = ""; }

            const div = document.createElement('div'); div.className = 'post-card';
            div.innerHTML = `
                <div class="post-header" onclick="openProfile('${post.uid}')">
                    <div class="post-avatar" style="${avaStyle}">${avaContent}</div>
                    <span class="post-user">${post.author}</span>
                    <span class="post-date">${date}</span>
                </div>
                <div class="post-content">${post.text}</div>
                <div class="post-actions"><span class="action-btn"><i class="fa-regular fa-heart"></i> Like</span></div>`;
            container.appendChild(div);
        }

        // --- PROFILE LOGIC ---
        app.comm.profileIcon.addEventListener('click', () => openProfile(currentUser.uid));
        document.getElementById('btn-back-feed').addEventListener('click', () => {
            app.comm.profileView.style.display = 'none';
            app.comm.feedView.style.display = 'block';
            app.comm.chatView.style.display = 'none';
        });

        function openProfile(uid) {
            viewingUserUid = uid;
            const isMe = (currentUser.uid === uid);
            
            app.comm.feedView.style.display = 'none';
            app.comm.profileView.style.display = 'block';
            app.comm.chatView.style.display = 'none';
            
            // Elements
            const pName = document.getElementById('p-name');
            const pBio = document.getElementById('p-bio');
            const pImg = document.getElementById('p-header-img');
            const btnEditImg = document.getElementById('btn-edit-img');
            const btnEditBio = document.getElementById('btn-edit-bio');
            const btnFollow = document.getElementById('btn-follow-action');
            const btnMsg = document.getElementById('btn-msg-action');
            const postSection = document.getElementById('profile-post-section');
            const postList = document.getElementById('profile-posts-list');

            // Reset UI
            pName.innerText = "Loading...";
            pBio.innerText = "...";
            pImg.style.backgroundImage = "none";
            postList.innerHTML = "";
            
            // Load User Data
            db_fire.collection('users').doc(uid).onSnapshot(doc => {
                if(!doc.exists) return;
                const data = doc.data();
                pName.innerText = data.username;
                pBio.innerText = data.bio || "No bio yet.";
                if(data.photoURL) pImg.style.backgroundImage = `url('${data.photoURL}')`;
                document.getElementById('p-followers').innerText = data.followers || 0;
                document.getElementById('p-following').innerText = data.following || 0;
            });

            // Load User Posts
            db_fire.collection('posts').where('uid', '==', uid).orderBy('timestamp', 'desc').limit(10).get().then(snap => {
                snap.forEach(doc => renderPost(doc.data(), postList));
            });

            // Modes
            if(isMe) {
                btnEditImg.style.display = 'flex';
                btnEditBio.style.display = 'inline-block';
                btnFollow.style.display = 'none';
                btnMsg.style.display = 'none';
                postSection.style.display = 'block';
            } else {
                btnEditImg.style.display = 'none';
                btnEditBio.style.display = 'none';
                btnFollow.style.display = 'inline-block';
                btnMsg.style.display = 'inline-block';
                postSection.style.display = 'none';
                checkIfFollowing(uid);
            }
        }

        // SAVE BIO FIX
        document.getElementById('btn-edit-bio').addEventListener('click', () => {
             const currentBio = document.getElementById('p-bio').innerText;
             const newBio = prompt("Neue Bio eingeben:", currentBio);
             if(newBio !== null) {
                 db_fire.collection('users').doc(currentUser.uid).update({ bio: newBio })
                 .then(() => alert("Bio gespeichert!"))
                 .catch(err => alert("Fehler beim Speichern: " + err.message));
             }
        });

        // IMAGE UPLOAD FIX
        document.getElementById('btn-edit-img').addEventListener('click', () => document.getElementById('profile-img-input').click());
        document.getElementById('profile-img-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const storageRef = storage.ref(`profiles/${currentUser.uid}`);
            const uploadTask = storageRef.put(file);
            
            uploadTask.on('state_changed', 
                (snap) => { console.log("Upload läuft..."); },
                (err) => { alert("Upload Fehler: " + err.message); },
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                        db_fire.collection('users').doc(currentUser.uid).update({ photoURL: url });
                        alert("Profilbild aktualisiert!");
                    });
                }
            );
        });

        // FOLLOW LOGIC
        document.getElementById('btn-follow-action').addEventListener('click', () => {
            if(!viewingUserUid) return;
            const followRef = db_fire.collection('follows').where('followerId', '==', currentUser.uid).where('followingId', '==', viewingUserUid);
            followRef.get().then(snap => {
                if(snap.empty) {
                    db_fire.collection('follows').add({ followerId: currentUser.uid, followingId: viewingUserUid });
                    db_fire.collection('users').doc(viewingUserUid).update({ followers: firebase.firestore.FieldValue.increment(1) });
                    db_fire.collection('users').doc(currentUser.uid).update({ following: firebase.firestore.FieldValue.increment(1) });
                    updateFollowBtn(true);
                } else {
                    snap.forEach(doc => doc.ref.delete());
                    db_fire.collection('users').doc(viewingUserUid).update({ followers: firebase.firestore.FieldValue.increment(-1) });
                    db_fire.collection('users').doc(currentUser.uid).update({ following: firebase.firestore.FieldValue.increment(-1) });
                    updateFollowBtn(false);
                }
            });
        });

        function checkIfFollowing(uid) {
             db_fire.collection('follows').where('followerId', '==', currentUser.uid).where('followingId', '==', uid)
             .onSnapshot(snap => updateFollowBtn(!snap.empty));
        }

        function updateFollowBtn(isFollowing) {
            const btn = document.getElementById('btn-follow-action');
            if(isFollowing) { btn.innerText = "Folge ich"; btn.classList.add('following'); } 
            else { btn.innerText = "Folgen"; btn.classList.remove('following'); }
        }

        // --- SEARCH ---
        app.comm.search.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const resBox = app.comm.results;
            if(term.length < 2) { resBox.style.display = 'none'; return; }
            
            db_fire.collection('users').where('searchKey', '>=', term).where('searchKey', '<=', term + '\uf8ff').limit(5)
            .get().then(snap => {
                resBox.innerHTML = "";
                if(snap.empty) { resBox.style.display = 'none'; return; }
                resBox.style.display = 'block';
                snap.forEach(doc => {
                     const u = doc.data();
                     const d = document.createElement('div');
                     d.className = 'search-item';
                     const img = u.photoURL ? `background-image:url('${u.photoURL}')` : `background:var(--accent-blue)`;
                     d.innerHTML = `<div class="s-avatar" style="${img}"></div><span>${u.username}</span>`;
                     d.onclick = () => {
                         resBox.style.display = 'none';
                         app.comm.search.value = "";
                         openProfile(doc.id);
                     };
                     resBox.appendChild(d);
                });
            });
        });

        // --- CHAT SYSTEM ---
        document.getElementById('btn-msg-action').addEventListener('click', () => startChat(viewingUserUid));
        document.getElementById('btn-close-chat').addEventListener('click', () => {
            app.comm.chatView.style.display = 'none';
            app.comm.profileView.style.display = 'block';
            activeChatId = null;
        });
        document.getElementById('chat-send').addEventListener('click', sendChatMessage);

        function startChat(partnerUid) {
            // ID = User1_User2 (alphabetical sort to be unique)
            const ids = [currentUser.uid, partnerUid].sort();
            activeChatId = ids.join("_");
            
            app.comm.profileView.style.display = 'none';
            app.comm.chatView.style.display = 'block';
            document.getElementById('chat-partner-name').innerText = document.getElementById('p-name').innerText;
            loadMessages();
        }

        function loadMessages() {
            const msgBox = document.getElementById('chat-messages');
            msgBox.innerHTML = "";
            
            db_fire.collection('chats').doc(activeChatId).collection('messages').orderBy('timestamp').onSnapshot(snap => {
                msgBox.innerHTML = "";
                snap.forEach(doc => {
                    const m = doc.data();
                    const bubble = document.createElement('div');
                    bubble.className = `chat-bubble ${m.senderId === currentUser.uid ? 'me' : 'them'}`;
                    bubble.innerText = m.text;
                    msgBox.appendChild(bubble);
                });
                msgBox.scrollTop = msgBox.scrollHeight;
            });
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const txt = input.value;
            if(!txt || !activeChatId) return;
            
            db_fire.collection('chats').doc(activeChatId).collection('messages').add({
                text: txt,
                senderId: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = "";
        }

        // --- STANDARD APP LOGIC (BASIS) ---
        // (Wetter, Map, Musik Logic is below, identical to 3.1.2)
        document.getElementById('auth-switch-btn').addEventListener('click', () => {
            isSignup = !isSignup;
            if(isSignup) { document.getElementById('btn-login-email').style.display='none'; document.getElementById('btn-signup-email').style.display='block'; }
            else { document.getElementById('btn-login-email').style.display='block'; document.getElementById('btn-signup-email').style.display='none'; }
        });
        document.getElementById('btn-login-email').addEventListener('click', () => auth.signInWithEmailAndPassword(document.getElementById('auth-email').value, document.getElementById('auth-pass').value).catch(err => alert(err.message)));
        document.getElementById('btn-signup-email').addEventListener('click', () => {
            const e = document.getElementById('auth-email').value; const p = document.getElementById('auth-pass').value;
            auth.createUserWithEmailAndPassword(e, p).then(cred => { 
                db_fire.collection('users').doc(cred.user.uid).set({ email: e, username: e.split('@')[0], searchKey: e.split('@')[0].toLowerCase() });
            }).catch(err => alert(err.message));
        });
        document.getElementById('btn-login-google').addEventListener('click', () => { const p = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(p).catch(e => alert(e.message)); });

        let db; const request = indexedDB.open("DriverHubDB", 1);
        request.onupgradeneeded = function(e) { db = e.target.result; db.createObjectStore("music", { keyPath: "id" }); };
        request.onsuccess = function(e) { db = e.target.result; loadMusicFromDB(); };
        function saveTrackToDB(t) { const tr = db.transaction(["music"], "readwrite"); tr.objectStore("music").add(t); }
        function loadMusicFromDB() { const tr = db.transaction(["music"], "readonly"); const r = tr.objectStore("music").getAll(); r.onsuccess = function() { if(r.result.length>0) { r.result.forEach(t=>playlist.push(t)); playlist.sort((a,b)=>b.id-a.id); renderPlaylist(); loadTrack(0,false); } }; }
        function renderPlaylist() { app.music.list.innerHTML = ""; playlist.forEach((t,i) => { const d=document.createElement('div'); d.className='track-row'; if(i===currentTrackIdx)d.classList.add('active'); d.innerHTML=`<div><h5>${t.title}</h5><p>${t.artist}</p></div><i class="fa-solid fa-play" style="font-size:0.8rem"></i>`; d.onclick=()=>loadTrack(i); app.music.list.appendChild(d); }); }
        function loadTrack(i,a=true) { if(i<0||i>=playlist.length)return; currentTrackIdx=i; audioPlayer.src=playlist[i].src; app.music.title.innerText=playlist[i].title; app.music.artist.innerText=playlist[i].artist; renderPlaylist(); if(a){audioPlayer.play().then(()=>{isPlaying=true;updatePlayBtn();}).catch(()=>{isPlaying=false;updatePlayBtn();});} }
        function togglePlay() { if(playlist.length===0){alert("Musik laden!");return;} if(isPlaying){audioPlayer.pause();isPlaying=false;}else{audioPlayer.play();isPlaying=true;} updatePlayBtn(); }
        function updatePlayBtn() { app.music.playBtn.innerHTML = isPlaying ? '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play"></i>'; if(isPlaying)app.music.aura.classList.add('playing'); else app.music.aura.classList.remove('playing'); }
        app.music.playBtn.onclick=togglePlay; app.music.nextBtn.onclick=()=>loadTrack(currentTrackIdx+1 >= playlist.length ? 0 : currentTrackIdx+1); app.music.prevBtn.onclick=()=>loadTrack(currentTrackIdx-1 < 0 ? playlist.length-1 : currentTrackIdx-1); app.music.volSlider.oninput=(e)=>audioPlayer.volume=e.target.value;
        app.music.fileInput.onchange=(e)=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(ev)=>{ const t={id:Date.now(),title:f.name.replace(/\.[^/.]+$/, ""),artist:"Local",src:ev.target.result}; saveTrackToDB(t); playlist.unshift(t); renderPlaylist(); loadTrack(0,true); }; r.readAsDataURL(f); };

        function initCoPilot() { const S=window.SpeechRecognition||window.webkitSpeechRecognition; if(!S)return; recognition=new S(); recognition.lang='de-DE'; recognition.onstart=()=>{app.copilotTrigger.classList.add('listening'); app.slogan.innerText="Höre zu...";}; recognition.onend=()=>{app.copilotTrigger.classList.remove('listening'); app.slogan.innerText="Tap Logo for Co-Pilot";}; recognition.onresult=(e)=>{handleVoiceCommand(e.results[0][0].transcript.toLowerCase());}; app.copilotTrigger.onclick=()=>{recognition.start();}; }
        function handleVoiceCommand(c) { let r="Nicht verstanden."; if(c.includes("fahrt")||c.includes("start")){r="Gute Fahrt!";app.screens.drive.style.display='flex';app.nav.style.display='none';startTracking();} else if(c.includes("musik")){togglePlay();r="Musik gestartet.";} speak(r); }
        function speak(t) { if(synth){const u=new SpeechSynthesisUtterance(t); synth.speak(u);} }

        document.querySelectorAll('.nav-item').forEach(b=>{b.onclick=()=>{document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); b.classList.add('active'); Object.values(app.screens).forEach(s=>{if(!s.classList.contains('screen-overlay'))s.classList.remove('active')}); app.screens[b.getAttribute('data-target').split('-')[0]].classList.add('active');}});
        document.getElementById('btn-start').onclick=()=>{app.screens.drive.style.display='flex';app.nav.style.display='none';startTracking();}; document.getElementById('btn-stop').onclick=()=>{stopTracking();app.screens.drive.style.display='none';app.screens.summary.style.display='flex';}; document.getElementById('btn-save-drive').onclick=()=>{saveDriveToStorage();app.screens.summary.style.display='none';app.nav.style.display='flex';document.querySelectorAll('.nav-item')[4].click();};
        function startTracking() { isDriving=true;startTime=new Date();path=[];currentDistance=0;currentMaxSpeed=0; if(!map){map=L.map('map',{zoomControl:false}).setView([51,10],13);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);marker=L.marker([0,0]).addTo(map);} intervalId=setInterval(()=>{app.display.time.innerText=new Date(new Date()-startTime).toISOString().substr(11,8);},1000); if(navigator.geolocation)watchId=navigator.geolocation.watchPosition(p=>{ const s=(p.coords.speed||0)*3.6; if(s>currentMaxSpeed)currentMaxSpeed=s; app.display.speed.innerText=s.toFixed(0); const l=[p.coords.latitude,p.coords.longitude]; marker.setLatLng(l); map.setView(l,18); if(path.length>0)currentDistance+=map.distance(path[path.length-1],l); app.display.dist.innerText=(currentDistance/1000).toFixed(2)+" km"; path.push(l); L.polyline(path,{color:'#4a90e2'}).addTo(map); }); }
        function stopTracking() { isDriving=false;clearInterval(intervalId);navigator.geolocation.clearWatch(watchId); document.getElementById('sum-dist').innerText=(currentDistance/1000).toFixed(2); document.getElementById('sum-time').innerText=app.display.time.innerText; }
        function saveDriveToStorage() { const d={id:Date.now(),date:startTime.toISOString(),distance:currentDistance/1000,maxSpeed:parseFloat(currentMaxSpeed),duration:app.display.time.innerText,pathData:path}; let l=JSON.parse(localStorage.getItem('dh_drives_v2'))||[];l.unshift(d);localStorage.setItem('dh_drives_v2',JSON.stringify(l));renderGarage(); }
        function renderGarage() { const l=JSON.parse(localStorage.getItem('dh_drives_v2'))||[]; document.getElementById('total-drives').innerText=l.length; document.getElementById('drives-list').innerHTML=l.map(d=>`<div class='drive-item'><div><h4>${new Date(d.date).toLocaleDateString()}</h4><span>${d.duration}</span></div><div class='right-side'><span class='dist'>${d.distance.toFixed(1)} km</span></div></div>`).join(''); }

        function manualRefreshWeather() { app.locText.innerText="Locating..."; if(navigator.geolocation)navigator.geolocation.getCurrentPosition(p=>{initWeatherLoc(p)},()=>{app.locText.innerText="No GPS";}); }
        function initWeatherLoc(p) { fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${p.coords.latitude}&lon=${p.coords.longitude}`).then(r=>r.json()).then(d=>{app.locText.innerText=d.address.city||"Loc Found"}); fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`).then(r=>r.json()).then(d=>{app.tempText.innerText=Math.round(d.current_weather.temperature)+"°";}); }
    </script>
</body>
</html>
